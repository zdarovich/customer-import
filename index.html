<!doctype html>
<html lang="en-us">
  <head>
    <title>Customer import</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
<!--    <link rel="stylesheet" href="main.css">-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
  <style>
    .container {
      width: 50%;
      margin-top: 3rem;
    }
    .loader {
      width: 5rem;
      height: 5rem;
      margin:auto;
    }
    li {
      margin-top: 1rem;
    }
  </style>
  </head>
  <body>
  <div id="app">
    <section class="section">
      <div class="container has-text-centered">
        <h1 class="title">Customer import</h1>
          <ul>

            <li>
              <label for="sessionKey">
                Erply session key:
                <input v-model="sessionKey" class="input is-danger" type="text" id="sessionKey" name="sessionKey" placeholder="sessionKey"></label>
            </li>
            <li>
              <label for="customerNumber">
                Erply customer number:
                <input v-model="customerNumber"  class="input is-danger" type="text" id="customerNumber" name="customerNumber" placeholder="customerNumber"></label>
            </li>
            <li>
              <label for="fileinput">
                CSV file:
                <input v-if="!loading" class="input is-danger" type="file" id="fileinput" ref="file" v-on:change="handleFileUpload()"/>
                <div v-else class="loader is-loading has-text-centered"></div>
              </label>
            </li>
            <li>
              <div class="columns">
                <div v-if="payload" class="column">
                  <p>customer's amount: {{payload.length}}</p>
                </div>
                <div v-if="fileError" class="column is-warning">
                  <p>error: {{fileError}}</p>
                </div>
              </div>
            </li>
          </ul>

      </div>
      <div class="container has-text-centered">
        <div class="columns is-multiline is-mobile">

          <div v-for="(row, index) in columns" :key="index" class="column is-2">
            <input v-model="row[2]" type="checkbox">
            <p>{{row[0]}}</p>
          </div>

        </div>

      </div>
      <div class="container has-text-centered">
        <button v-if="!uploading" v-on:click="upload()" class="button is-danger is-outlined" href="#" id="download">Upload</button>
        <div v-else class="loader is-loading has-text-centered"></div>

        <div v-if="uploadErrors.length !== 0" v-for="(err, index) in uploadErrors" :key="index">
          <p>
            {{err}}
          </p>
        </div>
      </div>
    </section>

  </div>

  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/papaparse@5.2.0/papaparse.min.js" type="text/javascript"></script>

  <!--  <script src="index.js"></script>-->
<script>
  let v = new Vue({
    el: "#app",
    data: {
      customers: [],
      uploading: false,
      uploadErrors: [],
      isError: false,
      fileError: null,
      results: null,
      loading: false,
      loaded: false,
      sessionKey: "",
      customerNumber: "",
      rowNames: {},
      payload: [],
      columns: [
        // CSV file rows : Erply rows : enabled or not
        ['ID','customerID',true],
        ['Name','companyName',true],
        ['First Name','firstName',true],
        ['Last Name','lastName',true],
        ['Bank','bankName',true],
      ],
      headers: {
        'access-control-allow-origin': '*',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      file:''
    },

    watch: {},
    computed: {

    },
    methods: {
      handleFileUpload(){
        let self = this
        this.loading = true
        Papa.parse(this.$refs.file.files[0], {
          complete: function(results) {
            console.log(results);
            self.loading = false
            self.loaded = true
            self.processFile(results)
          },
          error: function(err, file, inputElem, reason) {
            console.log(err);
            self.loading = false
            self.loaded = false
            self.isError = true
            self.fileError = err
          },
        });
      },
      processFile(results) {
        if (results && results.data) {
          // first el is row headers
          let headers = results.data[0]
          for (let i = 0; i < headers.length; i++) {
            this.rowNames[headers[i]] = i
          }
          this.payload = results.data.slice(1, results.data.length)
        }
      },
      upload() {
        if (!this.payload && !this.rowNames) {
          return
        }

        this.uploading = true
        let self = this
        let customers = []
        for (let i = 0; i < this.payload.length; i++) {
          let customer = {}
          for (let j = 0; j < this.columns.length; j++) {
            if (!this.columns[j][2]) {
                continue
            }
            let pos = this.rowNames[this.columns[j][0]]
            if (this.payload[i][pos]) {
              customer[this.columns[j][1]] = this.payload[i][pos]
            }
          }
          customers.push(customer)
        }
        this.customers = customers
        console.log(customers)

        for (let c in customers) {
          this.createCustomer(c)
                  .then(response => console.log([{ customerID: response.data.result.id }]))
                  .catch(err => {
                    console.log(err)
                    self.uploadErrors.push(err)
                  });
        }
        this.uploading = false
        },
      createCustomer: function (params) {
        let formData = new FormData();
        formData.append('request', 'saveCustomer')
        formData.append('clientCode', this.customerNumber)
        formData.append('sessionKey', this.sessionKey)
        for ( let key in params ) {
          formData.append(key, params[key]);

        }
        let url = 'https://' + this.customerNumber + '.erply.com/api/';
        return axios({
          method: 'post',
          url: url,
          data: formData,
          headers: this.headers
        })
      }
    },
  });


</script>
</html>
